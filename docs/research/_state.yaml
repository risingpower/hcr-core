# Research State
# Machine-readable current state for session continuity
#
# Update this at session end and read at session start.

version: "1.0"
last_updated: "2026-02-15"
last_session: "2026-02-15"

# Current focus
current:
  phase: "validation"  # discovery | research | implementation | validation
  focus: "Per-category baseline analysis complete. HCR opportunity zones identified (dpi, comparative, ambiguous). Ready to build HCR tree on benchmark corpus."
  blockers: []

# Research briefs status
briefs:
  active: []
  completed:
    - id: "RB-001"
      title: "Prior art survey"
      completed: "2026-02-13"
      key_finding: "12+ systems in the space since 2024. Hierarchical retrieval outperforms flat RAG on complex tasks (2-20pp gains). LATTICE is closest to HCR. No system targets hard token budgets. RAPTOR collapsed-tree result challenges strict top-down traversal."
    - id: "RB-002"
      title: "Theoretical basis: elimination vs similarity"
      completed: "2026-02-13"
      key_finding: "Strict top-down elimination is theoretically fragile — error compounds as (1-ε)^d. RAPTOR collapsed-tree result is structurally predicted, not anomalous. Hybrid coarse-to-fine (shallow elimination + flat search within survivors) is theoretically optimal. H1 needs reframing from 'elimination > similarity' to 'hierarchical coarse-to-fine with token budgets > flat retrieval'."
    - id: "RB-003"
      title: "Scoring mechanics"
      completed: "2026-02-13"
      key_finding: "Cascade architecture (hybrid BM25+dense → cross-encoder) achieves ε ≈ 0.01–0.02 per level at ~40–80ms. Strict admissibility impossible for semantic relevance. Path-relevance EMA is higher leverage than per-node scoring. Summary quality is #1 upstream factor. AdaGReS submodular knapsack for token-budget selection. H1c → 75%."
    - id: "RB-004"
      title: "Tree construction"
      completed: "2026-02-13"
      key_finding: "Four-source convergence on construction recipe: top-down divisive clustering (bisecting k-means, d=2–3, b∈[6,15]) + LLM contrastive routing summaries + soft assignment (1–3 parents per leaf). Routing summaries are a distinct artifact class: {theme, includes, excludes, key_entities, key_terms}. Gemini adds Q-STRUM Debate for adversarial contrastive generation, depth-variable summary formatting (contrastive prose at L1, keyword arrays + multi-vector at L2), Schema Entropy Bound and Sibling Distinctiveness (BM25 softmax) as concrete tree quality metrics, and EraRAG LSH hyperplanes as alternative partitioning with deterministic incremental maintenance. Cross-branch defense requires five layers. No routing-specific tree quality metric in literature — genuine research gap. H1b → 80%."
    - id: "RB-005"
      title: "Failure modes"
      completed: "2026-02-13"
      key_finding: "No architectural showstopper. 26 failure modes identified across all pipeline stages. Overall expected failure rate: 10–20%. Top residual risks: (1) DPI information loss for detail queries, (2) budget impossibility for aggregation/listing queries, (3) beam collapse without diversity enforcement. Three design changes needed: beam diversity, collapsed-tree as co-primary, external source handling. Entity cross-links elevated to primary mechanism for dominant query type (entity-centric). Transition period (small corpus) is highest-risk deployment phase."
    - id: "RB-006"
      title: "Benchmark design"
      completed: "2026-02-13"
      key_finding: "Four-source convergence on benchmark design. Hybrid corpus (50K–100K chunks from GitLab handbook + EnronQA + synthetic injectors). 300–400 stratified queries with budget-feasibility labels. 7 core metrics led by per-level routing accuracy ε (never measured in any system) and answer sufficiency under token constraint. 4 baselines (BM25, hybrid flat, flat+CE as kill baseline, RAPTOR). Fail-fast sequence with kill criteria at each step. MVB costs $15–30 in LLM API calls. Success criteria: HCR@400 ≥ flat@400 + 5pp, ε ≤ 0.03 per level, dual-path ≥ single-path + 3pp. Kill: flat+CE beats HCR at full corpus with significance."

# Baseline results (2026-02-15)
baseline_results:
  bm25:
    ndcg_at_10: 0.705
    recall_at_10: 0.82
    mrr: 0.669
    mean_tokens: 333
  hybrid_rrf:
    ndcg_at_10: 0.719
    recall_at_10: 0.90
    mrr: 0.662
    mean_tokens: 343
  flat_ce:
    ndcg_at_10: 0.835
    recall_at_10: 0.94
    mrr: 0.803
    mean_tokens: 354
  notes: "IR metrics computed on full ranked list (top-50). Token metrics on 400-token packed result. Median chunk ~470 tokens, so packing yields 0-1 chunks per query. Flat+CE is kill baseline. Results in benchmark/results/baseline_results.json (gitignored)."

# Implementation phases completed
implementation:
  phases_complete:
    - "Phase 1: Core types (Pydantic models)"
    - "Phase 2: Corpus pipeline (chunker, loader, embedder)"
    - "Phase 3: Index infrastructure (BM25, vector, hybrid)"
    - "Phase 4: LLM client + caching"
    - "Phase 5: Retrieval baselines (BM25, hybrid, flat+CE)"
    - "Phase 6: Evaluation metrics (epsilon, sufficiency, IR)"
    - "Phase 7: Query suite + benchmark runner"
    - "Phase 9: HCR core (tree builder, beam traversal, collapsed retrieval, dual-path, scoring cascade)"
    - "Code review fixes"
    - "Query generator fix (JSON fence stripping, Haiku model)"
    - "Sanity check passed (all baselines operational)"
    - "Baseline evaluation fix (separate ranking from token packing)"
    - "Baseline evaluation complete (BM25, hybrid, flat+CE)"
    - "Per-category baseline analysis (scripts/analyse_baselines.py)"
  test_count: 126
  mypy_status: "clean (30 source files)"
  ruff_status: "clean"

# Hypothesis summary
hypotheses:
  total: 3
  validated: 0
  invalidated: 0
  uncertain: 3
  retired: 1  # Original H1
  highest_confidence: "H1b (hybrid coarse-to-fine superiority) at 80%"
  lowest_confidence: "H1a (token efficiency) at 65%"
  notes: "Baselines established. Per-category analysis reveals HCR opportunity zones: dpi (CE nDCG=0.615, CE adds nothing over BM25), comparative (CE nDCG=0.663), ambiguous (CE nDCG=0.565 but N=2). CE is perfect on entity_spanning, multi_hop, aggregation, temporal — HCR can only win on token efficiency there."

# Knowledge accumulation
knowledge:
  patterns_discovered: 0
  variants_discovered: 0
  contexts_documented: 0
  domains_documented: 0
  edge_cases: 0

# Next actions (prioritized)
next_actions:
  - "Run HCR tree building on benchmark corpus: build tree, measure tree quality metrics (depth, branching factor, sibling distinctiveness)"
  - "Run HCR traversal (beam search + collapsed-tree dual-path) on the 50 queries"
  - "Compare HCR vs baselines — the kill criterion: does flat+CE beat HCR at full corpus with significance?"
  - "Focus HCR analysis on opportunity categories: dpi (7q), comparative (5q), ambiguous (2q), single_branch (12q)"
  - "If HCR shows promise: expand corpus and scale up (fail-fast experiment 2)"
  - "Implement full mode with LLM sufficiency judge (run_benchmark.py --mode full)"

# Notes for next session
notes: |
  Per-category baseline analysis complete. Key findings:

  HCR OPPORTUNITY ZONES (where CE is weakest):
  1. ambiguous (N=2): CE nDCG=0.565. All systems struggle. Low N = noisy.
  2. dpi (N=7): CE nDCG=0.615. CE adds +0.006 over BM25 — reranking doesn't help.
     Detail queries need structural routing, not better ranking.
  3. comparative (N=5): CE nDCG=0.663. CE helps (+0.451 over BM25) but still weak.
     Cross-branch comparison is structurally hard for flat retrieval.
  4. single_branch (N=12): CE nDCG=0.792. CE adds only +0.023 over BM25.

  CE PERFECT CATEGORIES (HCR can only win on tokens):
  - entity_spanning (N=10): CE=1.000
  - multi_hop (N=5): CE=1.000
  - aggregation (N=2): CE=1.000
  - temporal (N=2): CE=1.000

  Strategy: HCR should target dpi + comparative (12 queries combined) for accuracy
  wins, and match CE on the perfect categories while using fewer tokens.

  Per-query results saved to benchmark/results/per_query_results.json.
  Analysis script: python scripts/analyse_baselines.py

  Dependencies: pip install -e '.[dev]'
  Branch: 0215jc
